<apex:page standardController="Admission_Granted__c">
    <script src="/soap/ajax/30.0/connection.js" type="text/javascript"></script>
    <script src="/soap/ajax/15.0/apex.js" type="text/javascript"></script>

    <style>
        /* Style for the spinner */
        .spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Initially hidden spinner */
        #spinner {
            display: none;
        }
    </style>

    <script type="text/javascript">
        var AgId = '{!Admission_Granted__c.Id}';
        var SyncwithApplane = '{!Admission_Granted__c.Sync_With_Ether__c}';

        // Timeout duration (e.g., 30 seconds)
        var TIMEOUT_DURATION = 30000; 

        // Trigger the sync function on page load
        window.onload = function() {
            syncWithEther();
        };

        function syncWithEther() {
            // Disable the action temporarily
            document.body.style.pointerEvents = 'none'; // Disable all page interactions

            // Show the spinner
            document.getElementById('spinner').style.display = 'block';

            // Set a timeout to hide the spinner if the server does not respond in time
            var timeout = setTimeout(function() {
                // Hide spinner
                document.getElementById('spinner').style.display = 'none';
                document.body.style.pointerEvents = 'auto'; // Enable page interactions
                
                // Redirect to the current record page after timeout
                window.location.href = '/{!Admission_Granted__c.Id}';  // Redirect to the record page
                
                alert("Request timed out. Redirecting back to the record page.");
            }, TIMEOUT_DURATION);

            // If the record has not been synced, start the sync process
            if (SyncwithApplane != true) {
                // Call Apex controller to perform the sync operation
                var AG = sforce.apex.execute("AdmissionGrantedSyncHandler", "Ether_SyncAdmissionGranted", {
                    RecordID: AgId
                });

                // Clear the timeout once the operation completes
                clearTimeout(timeout);

                // Alert to show the result of the sync operation
                alert(AG);
                
                // Optionally, you can reload or update the page after sync completes
                // location.reload(); // Uncomment if needed
            } else {
                clearTimeout(timeout);  // Clear the timeout if the record is already synced
                alert("This record is already synced");
            }

            // Hide the spinner after the operation completes (if not already hidden by timeout)
            setTimeout(function() {
                document.getElementById('spinner').style.display = 'none';
                document.body.style.pointerEvents = 'auto'; // Enable page interactions again
            }, 2000); // Ensures the spinner hides even if the operation completes after the timeout
        }
    </script>

    <!-- Spinner element -->
    <div id="spinner" class="spinner"></div>

</apex:page>